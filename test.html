<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./CSS/style.css">
</head>
<body>
    <div class="container mt-4">
        <!-- Top Buttons and Search -->
        <div class="row mb-4">
            <div class="col">
                <button class="btn btn-primary" id="add-task-button">Add Task +</button>
            </div>
            <div class="col-6">
                <div class="input-group">
                    <input type="text" class="form-control bg-lightgrey" id="search-input" placeholder="Search...">
                    <span class="input-group-text">
                        <img id="search_icon" src="./icons/Search_Icon.png" alt="search_icon">
                    </span>
                </div>
            </div>
            <div class="col text-end">
                <button class="btn btn-primary">Add multiple +</button>
            </div>
        </div>

        <!-- Filtering by Priority -->
        <div class="row mb-4">
            <div class="col-md-4">
                <select class="form-select" id="filter-priority">
                    <option value="">Filter by Priority</option>
                    <option value="p1">P1</option>
                    <option value="p2">P2</option>
                    <option value="p3">P3</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-secondary" id="sort-asc-button">Sort by Due Date ↑</button>
                <button class="btn btn-secondary" id="sort-desc-button">Sort by Due Date ↓</button>
            </div>
        </div>

        <!-- Task Columns -->
        <div id="task-list" class="row">
            <!-- To Do Column -->
            <div class="col-md-4">
                <div class="board-column" id="todo-column">
                    <div class="column-header">
                        <h5>To do <span class="badge bg-secondary" id="todo-count">0</span></h5>
                    </div>
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="col-md-4">
                <div class="board-column" id="in-progress-column">
                    <div class="column-header">
                        <h5>In progress <span class="badge bg-secondary" id="in-progress-count">0</span></h5>
                    </div>
                </div>
            </div>

            <!-- Done Column -->
            <div class="col-md-4">
                <div class="board-column" id="done-column">
                    <div class="column-header">
                        <h5>Done <span class="badge bg-secondary" id="done-count">0</span></h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Adding Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-task-form">
                        <div class="mb-3">
                            <label for="task-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="task-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="task-description" class="form-label">Description</label>
                            <textarea class="form-control" id="task-description" rows="3" style="resize: none" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="task-status" class="form-label">Status</label>
                            <select class="form-select" id="task-status" required>
                                <option value="todo">To do</option>
                                <option value="in-progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="task-due-date" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="task-due-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="task-priority" class="form-label">Priority</label>
                            <select class="form-select" id="task-priority" required>
                                <option value="p1">P1</option>
                                <option value="p2">P2</option>
                                <option value="p3">P3</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-task-button">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

    <script>
        let currentTaskCard;

        // Set today's date as minimum date for due date input
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
            const yyyy = today.getFullYear();
            const minDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById('task-due-date').setAttribute('min', minDate);
        });

        document.getElementById('add-task-button').addEventListener('click', function() {
            var myModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            myModal.show();
        });

        document.getElementById('save-task-button').addEventListener('click', function() {
            // Validate form inputs
            if (!validateForm()) {
                return; // Stop execution if validation fails
            }

            var title = document.getElementById('task-title').value;
            var description = document.getElementById('task-description').value;
            var status = document.getElementById('task-status').value; // Get status from modal
            var dueDate = document.getElementById('task-due-date').value;
            var priority = document.getElementById('task-priority').value;

            addTaskCard(title, description, status, dueDate, priority);

            var myModal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            myModal.hide();
            document.getElementById('add-task-form').reset();
        });

        // Validate form inputs
        function validateForm() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;

            if (!title || !description || !dueDate) {
                alert("Please fill in all fields before saving the task.");
                return false;
            }

            const selectedDate = new Date(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set time to midnight for comparison

            if (selectedDate < today) {
                alert("The due date cannot be in the past. Please select a valid date.");
                return false;
            }

            return true;
        }

        // Adding a Task card
        function addTaskCard(title, description, status, dueDate, priority) {
            var taskCard = document.createElement('div');
            taskCard.className = `task-card ${priority} mb-2`;
            taskCard.dataset.priority = priority; // Store priority for filtering
            taskCard.dataset.dueDate = dueDate; // Store due date for sorting
            taskCard.innerHTML = `
                <div><strong>${title}</strong></div>
                <div>${description}</div>
                <div>Due: ${dueDate}</div>
                <div>
                    <button class="btn btn-danger btn-sm delete-task-button">Delete</button>
                    <button class="btn btn-warning btn-sm edit-task-button">Edit</button>
                </div>
            `;

            // Removing a task card
            taskCard.querySelector('.delete-task-button').addEventListener('click', function() {
                taskCard.remove();
                updateTaskCounts();
            });

            // Editing a task card
            taskCard.querySelector('.edit-task-button').addEventListener('click', function() {
                document.getElementById('task-title').value = title;
                document.getElementById('task-description').value = description;
                document.getElementById('task-status').value = status;
                document.getElementById('task-due-date').value = dueDate;
                document.getElementById('task-priority').value = priority;

                var myModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
                myModal.show();

                // Remove the card and re-add it after saving
                taskCard.remove();

                // When saving the task, we need to set a flag to indicate it's being edited
                document.getElementById('save-task-button').onclick = function() {
                    // Validate status change
                    if (!validateStatusChange()) {
                        return; // Stop execution if validation fails
                    }

                    // Save updated task
                    addTaskCard(title, description, status, dueDate, priority);
                    myModal.hide();
                };
            });

            // Append task card to the appropriate column
            var targetColumn = document.getElementById(status + '-column');
            targetColumn.appendChild(taskCard);
            updateTaskCounts();
            filterTasks(); // Apply current filter
        }

        // Validate status change only
        function validateStatusChange() {
            const status = document.getElementById('task-status').value;
            if (!status) {
                alert("Please select a status before saving.");
                return false;
            }
            return true;
        }

        // Filtering tasks by priority
        document.getElementById('filter-priority').addEventListener('change', function() {
            filterTasks();
        });

        // Sorting tasks by due date
        document.getElementById('sort-asc-button').addEventListener('click', function() {
            sortTasks('asc');
        });

        document.getElementById('sort-desc-button').addEventListener('click', function() {
            sortTasks('desc');
        });

        function filterTasks() {
            var selectedPriority = document.getElementById('filter-priority').value;
            var taskCards = document.querySelectorAll('.task-card');

            taskCards.forEach(function(card) {
                if (selectedPriority === "" || card.dataset.priority === selectedPriority) {
                    card.style.display = ""; // Show card
                } else {
                    card.style.display = "none"; // Hide card
                }
            });

            updateTaskCounts(); // Update counts after filtering
        }

        function updateTaskCounts() {
            document.getElementById('todo-count').textContent = countVisibleCards('todo-column');
            document.getElementById('in-progress-count').textContent = countVisibleCards('in-progress-column');
            document.getElementById('done-count').textContent = countVisibleCards('done-column');
        }

        function countVisibleCards(columnId) {
            const cards = document.querySelectorAll(`#${columnId} .task-card`);
            return Array.from(cards).filter(card => card.offsetParent !== null).length; // Count only visible cards
        }

        function sortTasks(order) {
            const columns = ['todo-column', 'in-progress-column', 'done-column'];
            const columnNames = {
                'todo-column': 'To do',
                'in-progress-column': 'In progress',
                'done-column': 'Done'
            };

            columns.forEach(columnId => {
                var column = document.getElementById(columnId);
                var cards = Array.from(column.getElementsByClassName('task-card'));

                // Sort cards based on due date
                cards.sort(function(a, b) {
                    var dateA = new Date(a.dataset.dueDate);
                    var dateB = new Date(b.dataset.dueDate);
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                });

                // Remove all cards from column and append sorted cards
                column.innerHTML = `<div class="column-header"><h5>${columnNames[columnId]} <span class="badge bg-secondary" id="${columnId}-count">0</span></h5></div>`;
                cards.forEach(function(card) {
                    column.appendChild(card);
                });
            });

            updateTaskCounts(); // Update counts after sorting
        }
    </script>
</body>
</html>
